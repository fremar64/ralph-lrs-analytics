services:
  clickhouse:
    image: 'clickhouse/clickhouse-server:24-alpine'
    container_name: ralph_clickhouse
    restart: unless-stopped
    cap_add:
      - SYS_NICE
      - NET_ADMIN
      - IPC_LOCK
    security_opt:
      - seccomp:unconfined
    environment:
      CLICKHOUSE_DB: '${CLICKHOUSE_DB:-ralph}'
      CLICKHOUSE_USER: '${CLICKHOUSE_USER:-ralph}'
      CLICKHOUSE_PASSWORD: '${CLICKHOUSE_PASSWORD}'
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    volumes:
      - 'clickhouse_data:/var/lib/clickhouse'
      - 'clickhouse_logs:/var/log/clickhouse-server'
    networks:
      - coolify
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  ralph:
    image: 'fundocker/ralph:5.0.1'
    container_name: ralph_lrs
    restart: unless-stopped
    environment:
      # Configuration pour le serveur LRS (API)
      RALPH_BACKENDS__LRS__CLICKHOUSE__HOST: clickhouse
      RALPH_BACKENDS__LRS__CLICKHOUSE__PORT: 8123
      RALPH_BACKENDS__LRS__CLICKHOUSE__DATABASE: '${CLICKHOUSE_DB:-ralph}'
      RALPH_BACKENDS__LRS__CLICKHOUSE__USERNAME: '${CLICKHOUSE_USER:-ralph}'
      RALPH_BACKENDS__LRS__CLICKHOUSE__PASSWORD: '${CLICKHOUSE_PASSWORD}'
      # Configuration pour les outils DATA (CLI)
      RALPH_BACKENDS__DATA__CLICKHOUSE__HOST: clickhouse
      RALPH_BACKENDS__DATA__CLICKHOUSE__PORT: 8123
      RALPH_BACKENDS__DATA__CLICKHOUSE__DATABASE: '${CLICKHOUSE_DB:-ralph}'
      RALPH_BACKENDS__DATA__CLICKHOUSE__USERNAME: '${CLICKHOUSE_USER:-ralph}'
      RALPH_BACKENDS__DATA__CLICKHOUSE__PASSWORD: '${CLICKHOUSE_PASSWORD}'
      # Param√®tres serveur
      RALPH_AUTH_FILE: /app/.ralph/auth.json
      RALPH_RUNSERVER_BACKEND: clickhouse
      RALPH_RUNSERVER_HOST: 0.0.0.0
      RALPH_RUNSERVER_PORT: 8100
      RALPH_LOGGING_LEVEL: INFO
    volumes:
      - 'ralph_data:/app/.ralph'
      - './auth.json:/app/.ralph/auth.json:ro'
    depends_on:
      clickhouse:
        condition: service_healthy
    networks:
      - coolify
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/xAPI/about"]
      interval: 30s
      timeout: 10s
      retries: 3
    command:
      - ralph
      - runserver
      - '--backend'
      - clickhouse
    labels:
      - traefik.enable=true
      - 'traefik.http.routers.ralph-lrs.rule=Host(`${RALPH_DOMAIN}`)'
      - traefik.http.routers.ralph-lrs.entrypoints=websecure
      - traefik.http.routers.ralph-lrs.tls.certresolver=letsencrypt
      - traefik.http.services.ralph-lrs.loadbalancer.server.port=8100

  grafana:
    image: 'grafana/grafana:11.3.0'
    container_name: ralph_grafana
    restart: unless-stopped
    environment:
      GF_SERVER_ROOT_URL: 'https://${GRAFANA_DOMAIN}'
      GF_SECURITY_ADMIN_USER: '${GRAFANA_ADMIN_USER:-admin}'
      GF_SECURITY_ADMIN_PASSWORD: '${GRAFANA_ADMIN_PASSWORD}'
      GF_INSTALL_PLUGINS: grafana-clickhouse-datasource
    volumes:
      - 'grafana_data:/var/lib/grafana'
      - './grafana/provisioning:/etc/grafana/provisioning:ro'
    depends_on:
      clickhouse:
        condition: service_healthy
    networks:
      - coolify
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=true
      - 'traefik.http.routers.grafana-ralph.rule=Host(`${GRAFANA_DOMAIN}`)'
      - traefik.http.routers.grafana-ralph.entrypoints=websecure
      - traefik.http.routers.grafana-ralph.tls.certresolver=letsencrypt
      - traefik.http.services.grafana-ralph.loadbalancer.server.port=3000

  superset-db:
    image: 'postgres:15-alpine'
    container_name: ralph_superset_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: superset
      POSTGRES_USER: superset
      POSTGRES_PASSWORD: '${SUPERSET_DB_PASSWORD}'
    volumes:
      - 'superset_db_data:/var/lib/postgresql/data'
    networks:
      - coolify
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U superset"]
      interval: 10s
      timeout: 5s
      retries: 5

  superset:
    image: 'apache/superset:4.0.2'
    container_name: ralph_superset
    restart: unless-stopped
    environment:
      SUPERSET_SECRET_KEY: '${SUPERSET_SECRET_KEY}'
      DATABASE_DIALECT: postgresql
      DATABASE_HOST: superset-db
      DATABASE_PORT: 5432
      DATABASE_DB: superset
      DATABASE_USER: superset
      DATABASE_PASSWORD: '${SUPERSET_DB_PASSWORD}'
      CLICKHOUSE_USER: '${CLICKHOUSE_USER:-ralph}'
      CLICKHOUSE_PASSWORD: '${CLICKHOUSE_PASSWORD}'
      CLICKHOUSE_DB: '${CLICKHOUSE_DB:-ralph}'
    volumes:
      - 'superset_data:/app/superset_home'
      - './superset/superset_config.py:/app/pythonpath/superset_config.py:ro'
    depends_on:
      superset-db:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    networks:
      - coolify
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - traefik.enable=true
      - 'traefik.http.routers.superset-ralph.rule=Host(`${SUPERSET_DOMAIN}`)'
      - traefik.http.routers.superset-ralph.entrypoints=websecure
      - traefik.http.routers.superset-ralph.tls.certresolver=letsencrypt
      - traefik.http.services.superset-ralph.loadbalancer.server.port=8088

networks:
  coolify:
    external: true

volumes:
  clickhouse_data:
  clickhouse_logs:
  ralph_data:
  grafana_data:
  superset_data:
  superset_db_data: